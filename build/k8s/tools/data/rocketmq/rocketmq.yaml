apiVersion: v1
kind: ConfigMap
metadata:
  name: rocketmq
  namespace: tools
data:
  # BROKER_MEM sets the broker JVM, if set to "" then Xms = Xmx = max(min(1/2 ram, 1024MB), min(1/4 ram, 8GB))
  BROKER_MEM: " -Xms2g -Xmx2g -Xmn1g "
  broker.conf: |
    # brokerClusterName, brokerName, brokerId are automatically generated by the operator and do not set it manually!!!
    brokerName = broker-a
    brokerId = 0
    deleteWhen = 04
    fileReservedTime = 48
    flushDiskType = ASYNC_FLUSH
    # set brokerRole to ASYNC_MASTER or SYNC_MASTER. DO NOT set to SLAVE because the replica instance will automatically be set!!!
    brokerRole = ASYNC_MASTER

---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: rocketmq
  name: rocketmq
  namespace: tools
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rocketmq
  minReadySeconds: 5
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app: rocketmq
    spec:
      containers:
        - name: broker
          image: apache/rocketmq
          imagePullPolicy: IfNotPresent
          command: ["sh","mqbroker", "-n","0.0.0.0:9876","-c","/conf/broker.conf"]
          volumeMounts:
            - mountPath: /home/rocketmq/store
              name: data
              subPath: store
            - mountPath: /home/rocketmq/logs
              name: data
              subPath: logs
            - mountPath: /conf/broker.conf
              name: config
              subPath: broker.conf
        - name: namesrv
          image: apacherocketmq/rocketmq
          command: [ "sh","mqnamesrv" ]
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 9876
          volumeMounts:
            - mountPath: /home/rocketmq/logs
              name: data
              subPath: logs
      volumes:
        - name: data
          hostPath:
            path: /data/rocketmq
            type: DirectoryOrCreate
        - name: config
          configMap:
            name: rocketmq
---
apiVersion: v1
kind: Service
metadata:
  name: rocketmq 
  namespace: tools
  labels:
    app: rocketmq 
spec:
  type: NodePort
  ports:
    - port: 9876
      name: server
      protocol: TCP
      nodePort: 9876
      targetPort: 9876
  selector:
    app: rocketmq 