apiVersion: v1
kind: ConfigMap
metadata:
  name: shadowsocks-conf
  namespace: tools
  labels:
    app: shadowsocks
data:
  config.json: |
    {
      "server": "172.17.0.3",
      "server_port": 8388,
      "local_port": 1080,
      "local_address": "0.0.0.0",
      "password": "password",
      "timeout": 300,
      "method": "aes-256-gcm"
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: shadowsocks
  namespace: tools
  labels:
    app: shadowsocks
spec:
  replicas: 1
  selector:
    matchLabels:
      app: shadowsocks
  template:
    metadata:
      labels:
        app: shadowsocks
    spec:
      containers:
        - name: shadowsocks
          image: ghcr.io/shadowsocks/sslocal-rust:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 1080
          volumeMounts:
            - mountPath: /etc/shadowsocks-rust/config.json
              subPath: config.json
              name: shadowsocks-config
      volumes:
        - name: shadowsocks-config
          configMap:
            name: shadowsocks-conf

---
apiVersion: v1
kind: Service
metadata:
  name: shadowsocks
  namespace: tools
  labels:
    app: shadowsocks
spec:
  type: NodePort
  ports:
    - port: 1080
      targetPort: 1080
      protocol: TCP
      nodePort: 1080
    - port: 1080
      targetPort: 1080
      protocol: UDP
      nodePort: 1080
  selector:
    app: shadowsocks

